
\section{Problem definition}

\subsection{Load balancing as a linear optimization problem}

On of the goals of SD-WAN is to minimize costs while still maintaining a set of requirements for a given set of applications. 


\begin{mdframed}[hidealllines=true,backgroundcolor=blue!20]
	With \textit{application} we mean any kind of source of internet traffic with a defined set of requirements. \\
	An application has a \textit{life cycle}: it starts, it generates data according to arbitrary rules and it terminates when no more data has to be sent. 
\end{mdframed} 


As a first step in formalizing the problem,  we can picture a scenario in which we have a CPE sending an arbitrary amount of packets to a sink. \\

The CPE is connected to the sink through a set of distinct links. \\

The goal of the CPE is to allow an \textit{application} to  transmit an arbitrary amount of packets to the sink. The transmission of data has some bounds in regards to:

\begin{itemize}
	\item Average bandwidth
	\item Average delay
	\item Average Packet loss
\end{itemize}


\begin{mdframed}[hidealllines=true,backgroundcolor=blue!20]
	An important assumption on the application requirements is that they only apply to the average: \\ if an application requires the average delay to be 100ms some of the packets can be sent \\ with an higher delay , as long as the overall delay stays under the desired threshold. \\
	Managing applications that have stricter requirements (e.g all packets must always be sent with \\ a maximum a delay of 100ms) go beyond the scope of our strategy.
\end{mdframed} 




Each link has different characteristics in regard to:
\begin{itemize}
	\item Available bandwidth \textit{(i.e how many bytes can be sent per second through the link)}
	\item Delay \textit{(i.e how long it takes for a packet to reach the sink)}
	\item Cost \textit{(i.e a metric used to track how convenient is to use a link instead of another, the section \ref{link_cost} goes into further details}
	\item Packet loss \textit{(i.e how many packets are lost and/or need to be sent multiple times?)}
\end{itemize} 



\subsubsection{Measuring the cost of links} \label{link_cost}
Each link as a cost associated with sending a packet on the link itself. \\
The cost of sending a packet is not a monetary cost, rather it is a measure of how convenient it is to use a given link. \\
Monetary costs for different kinds of connections are measured in multiple ways: i.e   MPLS connections charge increasing amount of money depending on the amount of traffic, while typical consumer ISPs charge a fixed amount regardless of the amount of traffic. \\
This cost for each packet is fixed for each link, and it does not change through the lifetime of any application. \\
This means that when assigning the packet cost to a given link we assign lower costs to the links that have a fixed monetary cost, and an higher cost to the link the have a pay-as-you-go model.


	
	\subsubsection{The problem as a linear optimization problem}
	
	We can formalize the problem as a linear optimization problem;
	As a starting point we consider an application sending an amount $N$ of packets of fixed size using three different links.
	
	The amount of packets is fixed and generated by a single application: our goal is to minimize the overall cost of the transmission while respecting the different requirements.
	
	To simplify the problem we set the bandwidth of the links in a way that it is always a multiple of the size of a single packet (i.e the bandwith of a link can only be an integer, 1 packet per second, 5 packet per second \dots)
	
	
	We consider a set of links $L$, to visualize the example we can set  $L = \{l_1, l_2, l_3 \}$. \\
	
	For each one we define
	\begin{itemize}
		\item The link delay:  $d_1, d_2, d_3$, measured in $ms$
		\item The link bandwidth: $b_1, b_2, b_3$, measured in \textit{packets per second (pps)}
		\item The cost for sending a single packet $c_1, c_2, c_3$
		\item The probability of losing a packet, expressed as a number in the range $ [0, 1)$
	\end{itemize}
	
	The total cost time required to send the packets can be expressed as:
	\[
	N_1 \cdot c_1 +
	N_2 \cdot c_2 +
	N_3 \cdot c_3 
	\]
	
	Where $N_i$ is the amount of packets sent on the the $ith$ interface.
	
	We also have to consider the bound on average delay:
	
	\[
	\frac
	{N_1 * d_1 + N_2 * d_2  + N_3 * d_3 }
	{N}
	\le \text{delay}
	\]
	
	The bound on average bandwidth:
	\[
	\frac
	{N_1 * b_1 + N_2 * b_2  + N_3 * b_3 }
	{N}
	\le \text{bandwidth}
	\]
	
	The bound on packet loss, expressed as a percentage:
	\[
	\frac
	{N_1 \cdot p_1 + N_2 \cdot p_2 + N_3 \cdot p_3 }
	{N}
	\le \text{packet loss}
	\]
	
	Finally, we need to express a bound to make sure every packet is actually sent.
	
	\[
	N_1 + N_2 + N_3 \ge N
	\]
	
	This simplified version of the problem can be expressed as: 
	
	\begin{equation}\label{eq:linear_formulation_final}
		\begin{dcases}
			\begin{aligned}
				& {\text{min}}
				& & N_1 \cdot c_1 + N_2 \cdot c_2 +	N_3 \cdot c_3 \\
				& \text{subject to:}
				& & \frac
				{N_1 \cdot d_1 + N_2 \cdot d_2  + N_3 \cdot d_3 }
				{N}
				\le \text{delay} \\
				& & & \frac
				{N_1 \cdot b_1 + N_2 \cdot b_2  + N_3 \cdot b_3 }
				{N}
				\le \text{bandwidth} \\
				& & & \frac
				{N_1 \cdot p_1 + N_2 \cdot p_2 + N_3 \cdot p_3 }
				{N}
				\le \text{packet loss} \\
				& & &
				N_1 + N_2 + N_3 \ge N
			\end{aligned}
		\end{dcases}
	\end{equation}
	
	
	
	\subsection{Extending the problem}
	While the linear optimization problem allows for an easy and clear solution, it can only work if some assumptions are made:
	
	\begin{itemize}
		\item Only a single application is sending data at any given time
		\item The amount of traffic generated by the application must be known beforehand (this is usually unrealistic, unless for specific situations, i.e file transfer)
	\end{itemize}
	
	This linear approach does also not take into account delays introduced by the outgoing traffic; the theoretical delay on a given link is only a lower bound.
	
	When sending multiple packages over an interface the time required to send the packages that are already into the queue must also be taken into account (e.g if  a package is sent through an interface where \textit{n} packages are already queued, the \textit{n} packages must be sent first)
	
	The linear optimization strategy is still useful to set a lower bound on the lowest possible overall transmission cost.
	
	To allow for modeling of more complex scenarios, we extend the problem definition to allow the presence of multiple applications.
	
	In this new scenario, each application can now generate traffic at any point of its lifetime: the total amount of traffic can not be determined until the end of the application lifecylce.
	
	Examples of different applications may include some that generates:
	\begin{itemize}
		\item A fixed amount of traffic every second.
		\item A random amount of traffic every hundred milliseconds
		\item A burst of traffic when starting the application, then no more.
		\item Any kind of commmonly studied traffic model (i.e Poisson distribution traffic model, Pareto distribution model)
		\item A simplified model of traffic (i.e sinusoidal traffic)
	\end{itemize}

	Any proposed solution must: 
	
	\begin{itemize}
		\item Be able to account for multiple sources of traffic
		\item Be able to account for the delay caused by the queuing of packages on a given interface
	\end{itemize}
	
	
	
	\section{An existing strategy}
	
	
	\subsection{Intent-Based Routing Policy}
	

	In the paper \textit{Intent-Based Routing Policy Optimization in SD-WAN} \cite{intent_based_routing} a strategy is discussed to optimize different metrics in a scenario with multiple applications (called "flow groups" in the original paper) with different QoS requirements; the traffic generated from a set of applications has to be distributed on a set of available links.
	
	The goal of the strategy is to provide the "best" possible split ratio for the traffic generated by the different applications among the available links.
	
	What is the "best" split ratio can be arbitrarily decided: in the original paper multiple metrics are proposed such as minimizing link utilization, or even improving the quality of the transmission beyond what is strictly required.
	
	The idea behind the strategy is run a linear optimization problem periodically so that it can adjust to changing demands by the different applications.
	
	The linear optimization resolution relies on an estimate to determine what the delay on a given link for a given application will be in the future; a similar approach could be used to estimate an error rate for a given application on a given link, as a starting point thought we suppose the error rate is always fixed given an link.
	
	
	\subsection{The linear optimization problem}
	
	The original paper provides a formulation with a linear programming model that may include different objectives, including:
	
	\begin{enumerate}
		\item An objective that measures if the SLA for a given application (in the original paper called a \textit{flow group}) can be violated. We will not allow for any violation of SLA, so this objective can be safely ignored.
		\item An objective function that minimizes the MLU (Maximum link utilization)
		\item An objective function that can eventually be used to decrease the delay beyond SLA requirements.
		\item An objective function that may be used to minimize costs.
	\end{enumerate}
	
	For our purposes, we can  modify the proposed model. While the importance of the various objective functions in the original formulation can be adjusted using weights, we can ignore most of the proposed functions (i.e setting their weight to 0).
	
	We consider a SD-WAN composed by a CPE sending data to a sink; the network is composed by:
	\begin{itemize}
		\item A set of links $L$ with bandwidth $B_l, \ \forall l \in L$
		\item A set of applications, $A$. For each application $a \in A$, the traffic demand is denoted with $t_a$, the required delay over all links is $\bar{D}_a$, the required bandwidth is $\bar{B}_a$ and the required error rate over all links is $\bar{E}_a$
	\end{itemize}
	
	The modified formulation is:
	\begin{center}
		\begin{align}
			\min & \quad \sum_{l \in L} c_l \cdot LU_l  \tag{1}
			\label{eq:objective}
			\\
			\text{s.t.} 
			& \quad LU_l = \sum_{a \in A} t_a x^a_l \leq C_l, 
			&& \forall l \in L, \tag{2} \label{eq:2} \\			
			% ^ Constraint on maximum bandwidth usage
			& \quad f^a_l(x) \leq D_a, 
			&& \forall a \in A, \forall l \in L, \tag{3} \label{eq:3} \\	
			% ^ Computing the estimated delay
			& \quad D_a \leq \bar{D}_a, 
			&& \forall a \in A, \tag{4} \label{eq:4} \\	
			% ^ Constraint on the delay
			& \quad e^a_l(x) \leq E_a, 
			&& \forall a \in A, \forall l \in L, \tag{5}  \label{eq:5} \\	
			% ^ Computing the estimated error rate
			& \quad E_a \leq \bar{E}_a, 
			&& \forall a \in A, \tag{6}  \label{eq:6} \\	
			% ^ Constraint on the estimated error rate
			& \quad b^a_l(x) \leq B_a, 
			&& \forall a \in A, \forall l \in L, \tag{7}  \label{eq:7} \\	
			% ^ Computing the estimated bandwidth usage
			& \quad B_a \leq \bar{B}_a, 
			&& \forall a \in A, \tag{8}  \label{eq:8} \\	
			% ^ Constraint on the estimated error rate
			& \quad \sum_{l \in L} x^a_l = 1, 
			&& \forall a \in A \tag{9}  \label{eq:9}
		\end{align}
	\end{center}
	
	The variables are:
	\begin{center}
		\begin{table}[htb]
			\centering
			\makegapedcells
			\begin{tabular}{|c|l|p{9cm}|}
				\hline
				Variable  & Range & \text{Notes}   \\ \hline
				$c$       & $R$ & The cost coefficient for a link   \\ \hline
				$x^a_l$       & $[0,1]$ & The split ratio of each application $a \in A$ over each link $l \in L$ \\ \hline
				$LU_l$       & $[0,1]$ & The utilization in percentage for each link $l \in L$ \\ \hline
				$D_a$       & $R$ & The maximum delay estimated by application $a$ over all overlay link \\ \hline
				$f^a_l(x)$       & $R$ & The delay function that provides the delay of application $a$ over overlay link $l$ considering the assignment given by $x$. This function will be discussed in greater detail in the \ref{estimating_the_delay} section.  \\ \hline
				$e^a_l(x)$       & $R$ & The error rate function that provides the error rate of application $a$ over overlay link $l$ considering the assignment given by $x$. This function will be discussed in greater detail in the \ref{estimating_the_error_rate} section \\ \hline
				$b^a_l(x)$       & $R$ & The bandwidth function that provides the required bandwidth rate of application $a$ over overlay link $l$ considering the assignment given by $x$. This function will be discussed in greater detail in the \ref{estimating_the_bandwidth_usage} section \\ \hline
			\end{tabular}
		\end{table}
	\end{center}
\pagebreak
The constraints are:

	\begin{center}
	\begin{table}[htb]
		\centering
		\makegapedcells
		\begin{tabular}{|c|p{9cm}|}
			\hline
			Constraint  & Meaning \\ \hline
			$\eqref{eq:2}$ & Ensures that the capacity of each link is satisfied  \\ \hline
			$\eqref{eq:3}$ & Computes the delay for each application over each link \\ \hline
			$\eqref{eq:4}$ & Verifies the satisfaction of SLA delay requirements  \\ \hline
			$\eqref{eq:5}$ & Computes the error rate for each application over each link  \\ \hline
			$\eqref{eq:6}$ & Verifies the satisfaction of SLA error rate requirements  \\ \hline
			$\eqref{eq:7}$ & Computes the bandwidth usage for each application over each link  \\ \hline
			$\eqref{eq:8}$ & Verifies the satisfaction of SLA bandwidth requirements  \\ \hline
			$\eqref{eq:9}$ & Ensures that all pending packets are sent  \\ \hline
		\end{tabular}
	\end{table}
\end{center}




\subsection{Estimating the delay} \label{estimating_the_delay}

The most intuitive approach for solving a linear optimization problem would be to keep using the cheapest links that meet the requirements to send the incoming packets. \\
The problem with this approach is that overusing an interface will inevitably lead to congestion. \\ While we know the upper bound of the bandwidth of any given link (i.e $B_l, \forall l \in L$), we must also take into account the reduction of bandwidth caused by the packets we previously sent.

In this paper we will rely on a very basic delay function, that it is purely based on how many packets arrived on a link up to a point in time.

When estimating the delay of sending $n$ packets on a given link, we can rely on the arrival rate up to that instant of time to approximate how much load is on a current link.

\[
	D_a =  \frac {n} {\text{arrival rate}}
\]

Where the arrival rate can be computed by considering how many packets were sent through the link up to a given point in time:
\[
	\text{arrival rate} = \frac {\text{total amount of packets}} {\text{current time}}
\]

Estimating the delay constitutes a challenge that opens for a lot of possible extensions to the current implementation, this will be further discussed in the future work session.


\subsection{Estimating the error rate} \label{estimating_the_error_rate}

Each link has a set error rate, expressed as a percentage, that affects how many packets actually reach the destination. For the scope of this paper the error rate will be fixed for every application and for every link. \\
However the error rate can potentially be any user-defined function to account for possibile changes in the links (e.g the error rate on a given link could rise when incoming traffic goes over a certain threshold)



\subsection{Estimating the bandwidth usage} \label{estimating_the_bandwidth_usage}

Each application has a pre-determined bandwidth usage, so we for the purpose of this paper there is no need to estimate what the necessary bandwidth for an application is. (i.e our function always returns a fixed value that is set by the application, in the case of a sinusoidal traffic model we will be considering the peak of the bandwidth usage as the required bandwidth) \\
However in other scenarios this function could be redefined to try and guess the future required bandwidth of any given application.